---
- name: Deploy FreelancingFuel app with Docker Compose
  hosts: appservers
  become: true

  vars:
    repo_url: "https://github.com/divyanshu1906/FreelancingFuel.git"
    project_dir: "/opt/freelancingfuel"
    compose_file: "{{ project_dir }}/docker-compose.yml"

  tasks:
    # ---------------------------
    # Install required packages
    # ---------------------------
    - name: Update apt cache
      apt:
        update_cache: yes
      when: ansible_os_family == 'Debian'

    - name: Install required packages
      apt:
        name:
          - git
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
      when: ansible_os_family == 'Debian'

    # ---------------------------
    # Install Docker
    # ---------------------------
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repo
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"

    - name: Install Docker engine & compose
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    # ---------------------------
    # Fetch latest code
    # ---------------------------
    - name: Create project directory
      file:
        path: "{{ project_dir }}"
        state: directory

    - name: Clone or update repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ project_dir }}"
        version: HEAD
        force: yes
      register: git_result

    # ---------------------------
    # Stop running containers
    # ---------------------------
    - name: Stop existing containers
      command: docker compose -f {{ compose_file }} down
      args:
        chdir: "{{ project_dir }}"
      ignore_errors: yes

    # ---------------------------
    # Clean old images (optional but recommended)
    # ---------------------------
    - name: Remove old backend & client images
      shell: |
        images=$(docker images --format '{{ "{{.Repository}}" }}:{{ "{{.Tag}}" }}' | grep 'freelancingfuel-' || true)
        if [ ! -z "$images" ]; then
          docker rmi -f $images || true
        fi
      ignore_errors: yes

    # ---------------------------
    # Rebuild images + start containers
    # ---------------------------
    - name: Rebuild & start new containers
      command: docker compose -f {{ compose_file }} up -d --build --remove-orphans
      args:
        chdir: "{{ project_dir }}"
      register: compose_up

    # ---------------------------
    # Debug output
    # ---------------------------
    - name: Show Docker status
      command: docker ps
      register: docker_ps

    - debug:
        var: docker_ps.stdout
